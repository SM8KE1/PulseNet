"use strict";const{app:n,BrowserWindow:m,dialog:g,ipcMain:a,shell:u,session:w}=require("electron"),t=require("path"),f=require("is-admin"),s=require("fs"),p=require("ping");function h(){try{let e;if(n.isPackaged){const o=t.dirname(n.getPath("exe"));e=t.join(o,"log.txt")}else e=t.join(n.getAppPath(),"log.txt");const r=t.dirname(e);if(!s.existsSync(r))try{s.mkdirSync(r,{recursive:!0}),console.log("Created directory:",r)}catch(o){throw console.error("Error creating directory:",o),o}if(!s.existsSync(e))try{s.writeFileSync(e,""),console.log("Created log file:",e)}catch(o){throw console.error("Error creating log file:",o),o}return e}catch(e){throw console.error("Error in getLogPath:",e),e}}function l(e){try{const r=h(),c=`[${new Date().toISOString()}] ${e}
`;s.appendFileSync(r,c)}catch(r){console.error("Error writing to log:",r),g.showErrorBox("خطا در نوشتن لاگ",`خطا در نوشتن فایل لاگ: ${r.message}`)}}function y(){try{const e=h();s.writeFileSync(e,""),console.log("Log file reset successfully")}catch(e){console.error("Error resetting log file:",e),g.showErrorBox("خطا در بازنویسی لاگ",`خطا در بازنویسی فایل لاگ: ${e.message}`)}}a.on("log-ping",(e,r)=>{l(r)});a.handle("ping-host",async(e,r)=>{try{const o=await p.promise.probe(r,{timeout:10,extra:["-c","1"]}),c=o.alive?`Success (${o.time} ms)`:"No Response";return l(`Ping to ${r}: ${c}`),{alive:o.alive,time:o.time,error:null}}catch(o){return l(`Ping to ${r}: Error: ${o.message}`),{alive:!1,time:null,error:o.message}}});a.on("open-github-link",()=>{u.openExternal("https://github.com/SM8KE1/PulseNet")});let i;function d(){i=new m({width:800,height:600,webPreferences:{preload:t.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0,webSecurity:!1},frame:!1,titleBarStyle:"hidden",backgroundColor:"#1a1a1a",icon:t.join(__dirname,"../assets/icon.ico"),title:"PulseNet"}),i.setMenu(null);const e=process.env.VITE_DEV_SERVER_URL;e?i.loadURL(e):i.loadFile(t.join(__dirname,"../dist/index.html")),a.on("minimize-window",()=>{i.minimize()}),a.on("close-window",()=>{i.close()})}async function E(){try{await f()||g.showMessageBox({type:"warning",title:"نیاز به دسترسی ادمین",message:"این برنامه برای اجرای دستورات پینگ نیاز به دسترسی ادمین دارد. لطفا برنامه را با دسترسی ادمین اجرا کنید.",buttons:["باشه"]})}catch(e){console.error("Error checking admin rights:",e)}}n.whenReady().then(async()=>{process.env.VITE_DEV_SERVER_URL||w.defaultSession.webRequest.onHeadersReceived((e,r)=>{r({responseHeaders:{...e.responseHeaders,"Content-Security-Policy":["script-src 'self'"]}})}),y(),await E(),d(),n.on("activate",()=>{m.getAllWindows().length===0&&d()})});n.on("window-all-closed",()=>{process.platform!=="darwin"&&n.quit()});
